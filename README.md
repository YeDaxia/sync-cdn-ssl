# SSL Certificate Sync Tool

English | [中文](README_CN.md)

This tool automatically synchronizes SSL certificates to **Alibaba Cloud (CDN & DCDN)** and **Qiniu Cloud**. It is designed to simplify the process of updating SSL certificates across multiple content delivery networks.

## Features

- **Alibaba Cloud**: Uploads certificates to CAS (Certificate Authority Service) and updates associated CDN and DCDN domains.
- **Qiniu Cloud**: Uploads certificates and updates associated domains.
- **Unified Execution**: Can run sync for all providers in one go or individually.

## Prerequisites

- Python 3.x
- pip (Python package installer)

## Installation

1. Clone the repository:
   ```bash
   git clone <repository_url>
   cd sync-cdn-ssl
   ```

2. Install the required dependencies:
   ```bash
   pip install -r requirements.txt
   ```

## Configuration

1. Create a `.env` file in the project root (you can copy the example below):

   ```ini
   # Alibaba Cloud Configuration
   ALIBABA_CLOUD_ACCESS_KEY_ID=your_aliyun_access_key
   ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_aliyun_secret_key
   
   # Qiniu Cloud Configuration
   QINIU_ACCESS_KEY=your_qiniu_access_key
   QINIU_SECRET_KEY=your_qiniu_secret_key
   
   # SSL Certificates Base Path
   # Directory where your certificate files are stored
   BASE_SSL_PATH=/etc/nginx/ssl
   
   # Target Domains (comma separated)
   # These domains must have corresponding certificate files in BASE_SSL_PATH
   TARGET_DOMAINS=example.com,another-domain.com
   ```

2. **Certificate File Naming Convention**:
   The tool expects certificate files to be present in the `BASE_SSL_PATH` directory with the following naming convention for each domain in `TARGET_DOMAINS`:
   
   - **Certificate (Full Chain)**: `<domain>.fullchain.cer`
   - **Private Key**: `<domain>.key`
   
   For example, if `TARGET_DOMAINS=example.com`, you must have:
   - `/etc/nginx/ssl/example.com.fullchain.cer`
   - `/etc/nginx/ssl/example.com.key`

## Generating SSL Certificates (Optional)

This tool works great with certificates generated by [acme.sh](https://github.com/acmesh-official/acme.sh). Here is a quick guide on how to generate certificates that match the naming convention of this tool.

1. **Install acme.sh**:
   ```bash
   curl https://get.acme.sh | sh -s email=my@example.com
   ```

2. **Issue a Certificate**:
   (Example using Alibaba Cloud DNS API)
   ```bash
   export Ali_Key="<key>"
   export Ali_Secret="<secret>"
   acme.sh --issue --dns dns_ali -d example.com -d *.example.com
   ```

3. **Install the Certificate**:
   Use the `--install-cert` command to copy the certificates to your `BASE_SSL_PATH` with the correct names.

   ```bash
   # Assuming BASE_SSL_PATH is /etc/nginx/ssl
   acme.sh --install-cert -d example.com \
   --key-file       /etc/nginx/ssl/example.com.key  \
   --fullchain-file /etc/nginx/ssl/example.com.fullchain.cer \
   --reloadcmd     "nginx -s reload"
   ```

   *Note: This command ensures that `acme.sh` will automatically renew the certificate and copy the updated files to the specified path, keeping them ready for this sync tool.*

## Usage

### Sync All Providers
To synchronize certificates to both Alibaba Cloud and Qiniu Cloud:

```bash
python3 sync_all.py
```

### Sync Individually
You can also run the scripts for specific providers independently:

- **Alibaba Cloud only**:
  ```bash
  python3 sync_ssl_aliyun.py
  ```

- **Qiniu Cloud only**:
  ```bash
  python3 sync_ssl_qiniu.py
  ```

## Notes

- Ensure that the user running the script has read permissions for the `BASE_SSL_PATH` directory and the certificate files.
- The tool uses the domain name as the suffix to find certificate files.
